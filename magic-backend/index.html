<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magic AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* --- CSS VARIABLES & THEME --- */
    :root {
      /* Base Colors - Dark Theme */
      --background-primary: #0A0A0F;
      --background-secondary: #141419;
      --background-elevated: #1C1C23;

      /* Gradients */
      --gradient-primary: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
      --gradient-active: linear-gradient(135deg, #10B981 0%, #3B82F6 100%);
      --gradient-translator: linear-gradient(135deg, #F59E0B 0%, #EF4444 100%);
      --gradient-coach: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);

      /* Text & UI */
      --text-primary: #FFFFFF;
      --text-secondary: #94A3B8;
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      --success: #10B981;
      --error: #EF4444;

      /* Spacing & Radius */
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;
      --radius-md: 0.5rem;
      --space-4: 1rem;
      --space-8: 2rem;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--background-primary);
      color: var(--text-primary);
      overflow: hidden;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* --- LOADING SCREEN --- */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--background-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-logo h1 {
      font-size: 2rem;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
    }

    /* --- MAIN APP --- */
    .app-container {
      position: relative;
      width: 100%;
      height: 100%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 2rem 1.5rem;
    }

    .noise-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><filter id="noiseFilter"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noiseFilter)" opacity="0.05"/></svg>');
      opacity: 0.05;
      pointer-events: none;
      z-index: 1;
    }

    /* --- TOP INDICATORS --- */
    .mode-indicator {
      position: absolute;
      top: 2rem;
      left: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      backdrop-filter: blur(20px);
      z-index: 10;
    }

    .mode-icon {
      width: 40px;
      height: 40px;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gradient-primary);
      transition: background 0.3s;
    }

    .mode-indicator.translator .mode-icon {
      background: var(--gradient-translator);
    }

    .mode-indicator.coach .mode-icon {
      background: var(--gradient-coach);
    }

    .mode-icon svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    .mode-text p {
      line-height: 1.2;
    }

    .mode-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .mode-description {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .settings-button {
      position: absolute;
      top: 2rem;
      right: 1.5rem;
      width: 48px;
      height: 48px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 0.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .settings-button svg {
      width: 24px;
      height: 24px;
      fill: var(--text-secondary);
    }

    /* --- MAGIC CIRCLE --- */
    .magic-circle {
      width: 260px;
      height: 260px;
      position: absolute;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--gradient-primary);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1), 0 8px 32px rgba(99, 102, 241, 0.4);
      z-index: 5;
      transition: transform 0.2s;
    }

    .magic-circle:active {
      transform: translate(-50%, -50%) scale(0.95);
    }

    .mic-icon {
      width: 64px;
      height: 64px;
      fill: white;
      margin-bottom: 0.5rem;
    }

    .state-text {
      font-size: 0.875rem;
      font-weight: 500;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    /* Animations */
    .magic-circle.idle {
      animation: pulse 4s infinite ease-in-out;
    }

    .magic-circle.listening {
      background: var(--gradient-active);
      animation: ripple 1.5s infinite;
    }

    .magic-circle.processing {
      background: var(--gradient-primary);
      animation: spin 2s linear infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: translate(-50%, -50%) scale(1);
      }

      50% {
        transform: translate(-50%, -50%) scale(1.03);
      }
    }

    @keyframes ripple {
      0% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      }

      100% {
        box-shadow: 0 0 0 50px rgba(16, 185, 129, 0);
      }
    }

    @keyframes spin {
      0% {
        transform: translate(-50%, -50%) rotate(0deg);
      }

      100% {
        transform: translate(-50%, -50%) rotate(360deg);
      }
    }

    /* --- TRANSCRIPTION & HISTORY --- */
    .transcription-container {
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
    }

    .transcription-text {
      font-size: 1.25rem;
      font-weight: 500;
      min-height: 3rem;
      margin-bottom: 1rem;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    .language-badges {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      align-items: center;
      opacity: 0.7;
      font-size: 0.875rem;
    }

    .conversation-history {
      position: fixed;
      right: 2rem;
      top: 20%;
      bottom: 20%;
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
      pointer-events: none;
      /* Let clicks pass through to background if needed */
    }

    .history-item {
      background: rgba(0, 0, 0, 0.4);
      padding: 1rem;
      border-radius: 1rem;
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      animation: slideIn 0.3s ease-out;
      pointer-events: auto;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* --- MODE SWITCH --- */
    .mode-switch {
      position: absolute;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      background: var(--glass-bg);
      padding: 0.5rem;
      border-radius: 2rem;
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      z-index: 10;
    }

    .mode-option {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-radius: 1.5rem;
      transition: all 0.3s;
    }

    .mode-option.active {
      background: var(--background-elevated);
      color: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .mode-option svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* --- TOASTS --- */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--error);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 100;
    }

    .toast.visible {
      opacity: 1;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .conversation-history {
        display: none;
      }
    }
  </style>
</head>

<body>

  <div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">
      <h1>Magic AI</h1>
    </div>
    <p>Initializing...</p>
  </div>

  <div class="app-container">
    <div class="noise-overlay"></div>

    <div class="mode-indicator translator" id="modeIndicator">
      <div class="mode-icon">
        <svg id="topIcon" viewBox="0 0 24 24">
          <path
            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
        </svg>
      </div>
      <div class="mode-text">
        <p class="mode-name" id="modeTitle">Universal Translator</p>
        <p class="mode-description">Speak naturally</p>
      </div>
    </div>

    <button class="settings-button"><svg viewBox="0 0 24 24">
        <path
          d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.488.488 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.56-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
      </svg></button>

    <div class="magic-circle idle" id="magicButton">
      <svg class="mic-icon" viewBox="0 0 24 24">
        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
        <path
          d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
      </svg>
      <p class="state-text" id="statusText">Tap to speak</p>
    </div>

    <div class="transcription-container">
      <p class="transcription-text" id="aiResponse">Ready to start.</p>
      <div class="language-badges">
        <span>ðŸ‡ªðŸ‡¸ Spanish</span>
        <span>â†’</span>
        <span>ðŸ‡ºðŸ‡¸ English</span>
      </div>
    </div>

    <div class="conversation-history" id="historyList">
    </div>

    <div class="mode-switch">
      <button class="mode-option active" onclick="setMode('translator')" id="btn-translator">
        <svg viewBox="0 0 24 24">
          <path
            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
        </svg>
        Translator
      </button>
      <button class="mode-option" onclick="setMode('coach')" id="btn-coach">
        <svg viewBox="0 0 24 24">
          <path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z" />
        </svg>
        Coach
      </button>
    </div>
  </div>

  <div class="toast" id="errorToast">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
    </svg>
    <p id="errorMsg">Connection error</p>
  </div>

  <script>
    // --- APP LOGIC ---
    // IMPORTANT: REPLACE THIS URL WITH YOUR CLOUD RUN URL IF DEPLOYED
    const BACKEND_URL = "http://localhost:8080";

    let currentMode = 'translator';
    let isListening = false;
    let session_id = "sess_" + Math.random().toString(36).substr(2, 9);

    // DOM Elements
    const magicBtn = document.getElementById('magicButton');
    const statusText = document.getElementById('statusText');
    const aiResponse = document.getElementById('aiResponse');
    const historyList = document.getElementById('historyList');
    const modeIndicator = document.getElementById('modeIndicator');
    const errorToast = document.getElementById('errorToast');
    const loadingScreen = document.getElementById('loadingScreen');

    // Remove loading screen on load
    window.addEventListener('load', () => {
      setTimeout(() => loadingScreen.classList.add('hidden'), 800);
    });

    // Mode Switching
    window.setMode = function (mode) {
      currentMode = mode;

      // Update Buttons
      document.getElementById('btn-translator').classList.toggle('active', mode === 'translator');
      document.getElementById('btn-coach').classList.toggle('active', mode === 'coach');

      // Update Top Indicator
      modeIndicator.className = `mode-indicator ${mode}`;
      document.getElementById('modeTitle').innerText = mode === 'translator' ? "Universal Translator" : "Language Coach";

      // Update Icon
      const iconPath = mode === 'translator'
        ? "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"
        : "M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z";
      document.getElementById('topIcon').innerHTML = `<path d="${iconPath}"/>`;
    };

    // Speech Recognition
    let recognition;
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onstart = () => {
        isListening = true;
        updateUIState('listening');
      };

      recognition.onresult = (event) => {
        const text = event.results[0][0].transcript;
        processTurn(text);
      };

      recognition.onend = () => {
        if (!isListening) updateUIState('idle');
      };

      recognition.onerror = (e) => {
        showError("Microphone error: " + e.error);
        updateUIState('idle');
      };
    } else {
      aiResponse.innerText = "Browser not supported. Use Chrome.";
    }

    magicBtn.onclick = () => {
      if (isListening) {
        recognition.stop();
        isListening = false;
        updateUIState('idle');
      } else {
        recognition.start();
      }
    };

    function updateUIState(state) {
      magicBtn.className = `magic-circle ${state}`;
      if (state === 'idle') statusText.innerText = "Tap to speak";
      if (state === 'listening') statusText.innerText = "Listening...";
      if (state === 'processing') statusText.innerText = "Thinking...";
    }

    async function processTurn(text) {
      updateUIState('processing');
      addToHistory("You", text);

      try {
        const res = await fetch(BACKEND_URL + '/turn', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_text: text,
            mode: currentMode,
            target_lang: "Spanish", // Default
            session_id: session_id
          })
        });

        if (!res.ok) throw new Error("Server Error");

        const data = await res.json();

        // Update UI
        updateUIState('idle');
        isListening = false;
        aiResponse.innerText = data.reply_text;
        addToHistory("AI", data.reply_text);

        // Play Audio
        if (data.audio_data) {
          const audio = new Audio("data:audio/mp3;base64," + data.audio_data);
          audio.play();
        }

      } catch (e) {
        console.error(e);
        updateUIState('idle');
        showError("Connection error. Is backend running?");
      }
    }

    function addToHistory(speaker, text) {
      const div = document.createElement('div');
      div.className = 'history-item';
      div.innerHTML = `<strong>${speaker}:</strong> ${text}`;
      historyList.prepend(div);
    }

    function showError(msg) {
      document.getElementById('errorMsg').innerText = msg;
      errorToast.classList.add('visible');
      setTimeout(() => errorToast.classList.remove('visible'), 3000);
    }
  </script>
</body>

</html>