<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic AI: Conversational OS</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #050505;
            --primary-glow: #8b5cf6;
            /* Violet */
            --secondary-glow: #06b6d4;
            /* Cyan */
            --glass-surface: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.5);
            --font-family: 'Outfit', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-family);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* --- AMBIENT BACKGROUND --- */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            box-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
            animation: moveStars 100s linear infinite;
        }

        @keyframes moveStars {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-2000px);
            }
        }

        .star-layer2 {
            animation: moveStars 150s linear infinite;
        }

        .star-layer3 {
            animation: moveStars 200s linear infinite;
        }

        .nebula {
            position: absolute;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 60%);
            filter: blur(80px);
            z-index: -1;
            animation: pulseNebula 10s infinite ease-in-out alternate;
        }

        @keyframes pulseNebula {
            0% {
                opacity: 0.3;
                transform: scale(1);
            }

            100% {
                opacity: 0.6;
                transform: scale(1.2);
            }
        }

        /* --- VIEW TRANSITIONS --- */
        .view {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            pointer-events: none;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            transform: scale(0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .view.active {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
        }

        /* --- HOME SCREEN --- */
        .hero-container {
            text-align: center;
            z-index: 10;
        }

        .hero-title {
            font-size: 82px;
            font-weight: 200;
            letter-spacing: -4px;
            margin: 0;
            background: linear-gradient(135deg, #fff 0%, #aaa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 80px rgba(255, 255, 255, 0.1);
        }

        .hero-title span {
            font-weight: 600;
            color: transparent;
            -webkit-text-stroke: 1px rgba(255, 255, 255, 0.8);
            -webkit-text-fill-color: transparent;
        }

        .hero-subtitle {
            font-size: 16px;
            color: var(--text-muted);
            font-weight: 300;
            letter-spacing: 3px;
            margin-top: 15px;
            text-transform: uppercase;
        }

        /* Auth Input */
        .auth-bar {
            margin-top: 60px;
            position: relative;
            width: 320px;
        }

        .input-line {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px 0;
            color: white;
            font-size: 16px;
            font-family: 'Outfit', sans-serif;
            text-align: center;
            transition: 0.4s;
        }

        .input-line:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--text-main);
            letter-spacing: 1px;
        }

        .btn-minimal {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 14px 34px;
            color: white;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 2px;
            cursor: pointer;
            transition: 0.3s;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .btn-minimal:hover {
            background: white;
            color: black;
            transform: translateY(-2px);
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.4);
        }

        /* --- DASHBOARD (POST AUTH) --- */
        .dash-grid {
            margin-top: 50px;
            display: flex;
            gap: 30px;
        }

        .glass-card {
            width: 160px;
            height: 220px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        .glass-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: 0.5s;
        }

        .glass-card:hover {
            transform: translateY(-10px) scale(1.05);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .glass-card:hover::before {
            opacity: 1;
        }

        .card-icon {
            font-size: 36px;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }

        .card-label {
            font-size: 12px;
            letter-spacing: 2px;
            font-weight: 500;
            color: var(--text-muted);
            transition: 0.3s;
        }

        .glass-card:hover .card-label {
            color: white;
        }

        .settings-bar {
            position: absolute;
            bottom: 40px;
            display: flex;
            gap: 20px;
        }

        .minimal-select {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            cursor: pointer;
            transition: 0.3s;
            text-align: center;
            appearance: none;
            /* Hide default arrow */
            -webkit-appearance: none;
        }

        .minimal-select:hover {
            color: white;
        }

        .minimal-select:focus {
            outline: none;
        }

        /* --- WORKSPACE VIEW --- */
        .workspace-header {
            position: absolute;
            top: 40px;
            left: 40px;
            right: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .mode-indicator {
            font-size: 12px;
            letter-spacing: 3px;
            color: var(--text-muted);
            border: 1px solid var(--glass-border);
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.3);
        }

        .exit-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
            transition: 0.3s;
        }

        .exit-btn:hover {
            color: white;
            transform: rotate(90deg);
        }

        /* THE ORB */
        .orb-stage {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .core {
            width: 140px;
            height: 140px;
            background: radial-gradient(circle at 30% 30%, #fff, #888);
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 0 60px rgba(255, 255, 255, 0.2);
            transition: 0.4s ease;
        }

        .listening .core {
            box-shadow: 0 0 100px var(--primary-glow);
            background: var(--primary-glow);
        }

        .wave {
            position: absolute;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: scale(0.5);
            transition: transform 0.1s;
        }

        .w1 {
            border-color: rgba(6, 182, 212, 0.5);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.3), inset 0 0 10px rgba(6, 182, 212, 0.2);
            transition: all 0.3s ease;
        }

        /* Cyan Default */

        .w2 {
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3), inset 0 0 10px rgba(139, 92, 246, 0.2);
            transition: all 0.3s ease;
        }

        /* Violet Default */

        /* USER SPEAKING (Listening Mode) */
        .stage-listening .w1 {
            border-color: #06b6d4;
            box-shadow: 0 0 30px #06b6d4;
        }

        .stage-listening .w2 {
            border-color: #8b5cf6;
            box-shadow: 0 0 30px #8b5cf6;
        }

        /* MAGIC SPEAKING (Speaking Mode) */
        .stage-speaking .w1 {
            border-color: #fbbf24;
            box-shadow: 0 0 40px #fbbf24;
        }

        /* Gold */
        .stage-speaking .w2 {
            border-color: #f472b6;
            box-shadow: 0 0 40px #f472b6;
        }

        /* Pink */




        /* Violet */

        /* Text Area */
        .transcript-area {
            margin-top: 60px;
            text-align: center;
            width: 100%;
            max-width: 800px;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .main-text {
            font-size: 28px;
            font-weight: 300;
            line-height: 1.4;
            color: white;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
        }

        .sub-text {
            margin-top: 20px;
            font-size: 18px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            font-weight: 300;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            max-width: 100%;
        }

        .utility-classes {
            display: none;
        }

        .visible {
            display: flex !important;
            animation: fadeIn 1s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- SIMPLE FADE --- */
        .simple-fade {
            animation: fadeInBlock 0.5s ease-out forwards;
        }

        @keyframes fadeInBlock {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div id="starfield"></div>
    <div class="nebula"></div>

    <!-- HOME -->
    <div id="view-home" class="view active">
        <div class="hero-container">
            <h1 class="hero-title">MAGIC <span>AI</span></h1>
            <div class="hero-subtitle">Conversational Operating System</div>
        </div>

        <div id="auth-panel" class="auth-bar">
            <input type="text" id="username-in" class="input-line" placeholder="Identify User" autocomplete="off">
            <div style="text-align: center; margin-top: 10px;">
                <button class="btn-minimal" onclick="handleAuth()">INITIALIZE</button>
            </div>
        </div>

        <div id="dash-panel" class="dash-grid utility-classes">
            <div class="glass-card" onclick="launchMode('coach')">
                <div class="card-icon">üéì</div>
                <div class="card-label">COACH</div>
            </div>
            <div class="glass-card" onclick="launchMode('translator')"
                style="border-bottom: 2px solid var(--secondary-glow);">
                <div class="card-icon">üåç</div>
                <div class="card-label">TRANSLATOR</div>
            </div>
        </div>

        <div class="settings-bar">
            <select id="native-lang-select" class="minimal-select" style="text-align-last: center;">
                <option value="en-US">I Speak: English (US)</option>
                <optgroup label="European">
                    <option value="es-ES">I Speak: Spanish (Spain)</option>
                    <option value="es-MX">I Speak: Spanish (Mexico)</option>
                    <option value="fr-FR">I Speak: French</option>
                    <option value="de-DE">I Speak: German</option>
                    <option value="it-IT">I Speak: Italian</option>
                    <option value="pt-PT">I Speak: Portuguese</option>
                    <option value="pl-PL">I Speak: Polish</option>
                    <option value="ru-RU">I Speak: Russian</option>
                    <option value="nl-NL">I Speak: Dutch</option>
                    <option value="tr-TR">I Speak: Turkish</option>
                    <option value="el-GR">I Speak: Greek</option>
                    <option value="sv-SE">I Speak: Swedish</option>
                    <option value="no-NO">I Speak: Norwegian</option>
                    <option value="da-DK">I Speak: Danish</option>
                    <option value="fi-FI">I Speak: Finnish</option>
                    <option value="cs-CZ">I Speak: Czech</option>
                    <option value="hu-HU">I Speak: Hungarian</option>
                    <option value="ro-RO">I Speak: Romanian</option>
                    <option value="uk-UA">I Speak: Ukrainian</option>
                </optgroup>
                <optgroup label="Indian">
                    <option value="hi-IN">I Speak: Hindi</option>
                    <option value="ta-IN">I Speak: Tamil</option>
                    <option value="bn-IN">I Speak: Bengali</option>
                    <option value="gu-IN">I Speak: Gujarati</option>
                    <option value="kn-IN">I Speak: Kannada</option>
                    <option value="ml-IN">I Speak: Malayalam</option>
                    <option value="te-IN">I Speak: Telugu</option>
                    <option value="mr-IN">I Speak: Marathi</option>
                    <option value="pa-IN">I Speak: Punjabi</option>
                    <option value="ur-PK">I Speak: Urdu</option>
                </optgroup>
                <optgroup label="Asian">
                    <option value="zh-CN">I Speak: Mandarin</option>
                    <option value="ja-JP">I Speak: Japanese</option>
                    <option value="ko-KR">I Speak: Korean</option>
                    <option value="vi-VN">I Speak: Vietnamese</option>
                    <option value="th-TH">I Speak: Thai</option>
                    <option value="id-ID">I Speak: Indonesian</option>
                    <option value="ms-MY">I Speak: Malay</option>
                    <option value="fil-PH">I Speak: Filipino</option>
                </optgroup>
                <optgroup label="Middle Eastern & African">
                    <option value="ar-SA">I Speak: Arabic</option>
                    <option value="he-IL">I Speak: Hebrew</option>
                    <option value="fa-IR">I Speak: Persian</option>
                    <option value="sw-KE">I Speak: Swahili</option>
                    <option value="am-ET">I Speak: Amharic</option>
                    <option value="yo-NG">I Speak: Yoruba</option>
                    <option value="zu-ZA">I Speak: Zulu</option>
                    <option value="ha-NG">I Speak: Hausa</option>
                </optgroup>
            </select>
            <select id="voice-select" class="minimal-select">
                <option value="rachel">Voice: Rachel</option>
                <option value="antoni">Voice: Antoni</option>
                <option value="bella">Voice: Bella</option>
                <option value="josh">Voice: Josh</option>
            </select>
        </div>
    </div>

    <!-- WORKSPACE -->
    <div id="view-workspace" class="view">
        <div class="workspace-header">
            <div id="user-display" class="mode-indicator" style="border:none; color:white;">GUEST</div>
            <div id="active-mode-title" class="mode-indicator">MODE</div>
            <button class="exit-btn" onclick="exitWorkspace()">‚úï</button>
        </div>

        <div id="stage" class="orb-stage" onclick="toggleListening()">
            <div class="wave w1"></div>
            <div class="wave w2"></div>
            <div class="wave w3"></div>
            <div class="core"></div>
        </div>

        <!-- PARTNER TOGGLE -->
        <div style="text-align:center; margin-top:20px; z-index: 100;">
            <button id="partner-btn" class="btn-minimal" onclick="togglePartnerMode(event)"
                style="margin:0; padding: 10px 20px;">
                LISTEN TO: <span id="partner-label">ME (NATIVE)</span>
            </button>
        </div>

        <div class="transcript-area">
            <div id="status-label"
                style="font-size: 10px; letter-spacing: 4px; margin-bottom: 20px; color: var(--secondary-glow);">SYSTEM
                READY</div>
            <div id="live-transcript" class="main-text"></div>
            <div id="last-response" class="sub-text"></div>
        </div>
    </div>

    <script>
        const BACKEND_URL = "http://localhost:8080";
        let currentUser = "Guest";
        let currentMode = "coach";
        let isListening = false;
        let listenToPartner = false;
        let targetLangCode = "Unspecified";

        // --- PARALLAX ---
        document.addEventListener('mousemove', (e) => {
            const x = (e.clientX / window.innerWidth - 0.5) * 20;
            const y = (e.clientY / window.innerHeight - 0.5) * 20;
            document.getElementById('starfield').style.transform = `translate(${x}px, ${y}px)`;
        });

        // --- AUTH ---
        function handleAuth() {
            const name = document.getElementById('username-in').value;
            currentUser = name || "Guest";
            document.getElementById('auth-panel').style.display = 'none';
            document.getElementById('dash-panel').classList.add('visible');
            document.getElementById('user-display').innerText = currentUser.toUpperCase();

            // Register
            fetch(BACKEND_URL + '/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentUser })
            }).catch(e => console.warn("Shadow login offline"));
        }

        // --- MODE SWITCHING ---
        function launchMode(mode) {
            currentMode = mode;
            document.getElementById('view-home').classList.remove('active');
            document.getElementById('view-workspace').classList.add('active');
            document.getElementById('active-mode-title').innerText = mode.toUpperCase();

            // Clear previous context
            document.getElementById('live-transcript').innerText = "";
            document.getElementById('last-response').innerText = "";

            let color = mode === 'coach' ? '#8b5cf6' : '#06b6d4';
            document.documentElement.style.setProperty('--primary-glow', color);

            listenToPartner = false;
            updatePartnerUI();

            // Hide/Show Partner Toggle
            const pBtn = document.getElementById('partner-btn').parentElement;
            pBtn.style.display = (mode === 'coach') ? 'none' : 'block';
        }

        function exitWorkspace() {
            stopListening();
            document.getElementById('view-workspace').classList.remove('active');
            document.getElementById('view-home').classList.add('active');
        }

        // --- PARTNER MODE ---
        function togglePartnerMode(e) {
            e.stopPropagation();

            // SECURITY: Prevent listening to unknown language (causes garbage STT)
            if (!listenToPartner && (targetLangCode === 'Unspecified' || targetLangCode === 'null')) {
                document.getElementById('status-label').innerText = "WHICH LANGUAGE? SAY: \"SWITCH TO [LANGUAGE]\"";
                const synth = window.speechSynthesis;
                const u = new SpeechSynthesisUtterance("Please tell me which language to switch to first.");
                synth.speak(u);
                return;
            }

            if (isListening) stopListening();
            listenToPartner = !listenToPartner;
            updatePartnerUI();
        }

        function updatePartnerUI() {
            const btn = document.getElementById('partner-btn');
            const label = document.getElementById('partner-label');

            if (listenToPartner) {
                label.innerText = "PARTNER (" + (targetLangCode === 'Unspecified' ? 'UNKNOWN' : targetLangCode) + ")";
                btn.style.background = "white";
                btn.style.color = "black";
            } else {
                label.innerText = "ME (NATIVE)";
                btn.style.background = "rgba(255,255,255,0.1)";
                btn.style.color = "white";
            }
        }

        // --- SPEECH ---
        let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        document.getElementById('native-lang-select').addEventListener('change', (e) => {
            if (!listenToPartner) recognition.lang = e.target.value;
        });

        recognition.onstart = () => {
            isListening = true;
            document.getElementById('stage').classList.add('listening');
            document.getElementById('stage').classList.add('stage-listening'); // User Colors
            document.getElementById('status-label').innerText = listenToPartner ? "LISTENING TO PARTNER..." : "LISTENING...";
            startVisualizer();
        };

        recognition.onresult = (event) => {
            const t = event.results[0][0].transcript;
            document.getElementById('live-transcript').innerText = t;
            if (event.results[0].isFinal) processTurn(t);
        };

        recognition.onend = () => {
            if (isListening) {
                stopVisualizer();
                document.getElementById('stage').classList.remove('listening');
                document.getElementById('stage').classList.remove('stage-listening');
                if (document.getElementById('status-label').innerText.includes("LISTENING")) {
                    document.getElementById('status-label').innerText = "PROCESSING...";
                }
            }
        };

        function toggleListening() { isListening ? stopListening() : startListening(); }
        function startListening() {
            if (listenToPartner) {
                recognition.lang = targetLangCode !== 'Unspecified' ? targetLangCode : 'en-US';
                // Fallback to English but really we need the target lang
            } else {
                recognition.lang = document.getElementById('native-lang-select').value;
            }
            console.log("Mic Lang:", recognition.lang);
            recognition.start();
        }
        function stopListening() { isListening = false; recognition.stop(); }

        // --- VISUALIZER ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let analyser, micSource, frame;
        let globalStream = null;

        async function startVisualizer() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            try {
                if (!globalStream) {
                    globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                }

                // Only create source if not already connected
                if (!micSource) {
                    micSource = audioCtx.createMediaStreamSource(globalStream);
                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 64;
                    micSource.connect(analyser);
                }
                loopVisualizer();
            } catch (e) { console.error("Mic Access Error:", e); }
        }

        function stopVisualizer() {
            if (frame) cancelAnimationFrame(frame);
            if (micSource) micSource.disconnect();
            document.querySelectorAll('.wave').forEach(w => w.style.transform = 'scale(0.5)');
        }

        function loopVisualizer() {
            frame = requestAnimationFrame(loopVisualizer);
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            let sum = 0;
            data.forEach(v => sum += v);
            let scale = 1 + (sum / data.length / 40);

            document.querySelector('.core').style.transform = `scale(${scale})`;
            document.querySelector('.w1').style.transform = `scale(${scale * 1.2})`;
            document.querySelector('.w2').style.transform = `scale(${scale * 1.5})`;
        }

        // --- BRAIN ---
        async function processTurn(text) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s Timeout

                const res = await fetch(BACKEND_URL + '/turn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    signal: controller.signal,
                    body: JSON.stringify({
                        user_text: text,
                        mode: currentMode,
                        user_id: currentUser,
                        native_lang: document.getElementById('native-lang-select').value,
                        voice_persona: document.getElementById('voice-select').value,
                        msg_direction: listenToPartner ? 'them_to_me' : 'me_to_them'
                    })
                });
                clearTimeout(timeoutId);

                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);

                const data = await res.json();

                // TTS ERROR HANDLING
                if (data.tts_error) {
                    console.warn("Backend Voice Error:", data.tts_error);
                    let errMsg = "VOICE ERROR";
                    if (data.tts_error === "auth_failed") errMsg = "KEY INVALID";
                    if (data.tts_error === "auth_missing") errMsg = "KEY MISSING";
                    if (data.tts_error === "quota_exceeded") errMsg = "QUOTA EXCEEDED";

                    document.getElementById('status-label').innerText = errMsg;
                    document.getElementById('status-label').style.color = "#ef4444"; // Red warning

                    // Reset after 3s
                    setTimeout(() => {
                        document.getElementById('status-label').innerText = "SPEAKING"; // Allow fallback to take over visual state
                        document.getElementById('status-label').style.color = "var(--secondary-glow)";
                    }, 3000);
                }

                // Update Target Lang?
                if (data.lang_update && data.lang_update !== "null") {
                    targetLangCode = data.lang_update;
                    if (listenToPartner) updatePartnerUI();
                }

                // Update Native Lang?
                if (data.native_lang_update && data.native_lang_update !== "null") {
                    const sel = document.getElementById('native-lang-select');
                    let match = Array.from(sel.options).find(o => o.value === data.native_lang_update || o.value.startsWith(data.native_lang_update));
                    if (match) {
                        sel.value = match.value;
                        if (!listenToPartner) recognition.lang = match.value;
                        document.getElementById('status-label').innerText = "SWITCHED TO " + match.text.split(":")[1].toUpperCase();
                    }
                }

                const respEl = document.getElementById('last-response');
                respEl.innerText = data.reply_text;
                // Trigger Fade
                respEl.classList.remove('simple-fade');
                void respEl.offsetWidth; // trigger reflow
                respEl.classList.add('simple-fade');

                // Don't overwrite error status
                if (!document.getElementById('status-label').innerText.includes("ERROR") && !document.getElementById('status-label').innerText.includes("KEY")) {
                    document.getElementById('status-label').innerText = "SPEAKING";
                }
                document.getElementById('stage').classList.add('stage-speaking');

                if (data.audio_data) {
                    try {
                        const audio = new Audio("data:audio/mp3;base64," + data.audio_data);
                        // Safe Playback
                        const playPromise = audio.play();

                        if (playPromise !== undefined) {
                            playPromise
                                .then(_ => {
                                    audio.onended = () => {
                                        document.getElementById('status-label').innerText = "READY";
                                        document.getElementById('stage').classList.remove('stage-speaking');
                                        // AUTO-MIC for Translator Mode
                                        if (currentMode === 'translator') {
                                            setTimeout(() => {
                                                if (!isListening) startListening();
                                            }, 500); // Small pause for natural turn-taking
                                        }
                                    };
                                })
                                .catch(error => {
                                    console.warn("Audio Autoplay Blocked/Failed", error);
                                    document.getElementById('status-label').innerText = "READY";
                                });
                        }
                    } catch (e) {
                        console.error("Audio Decoding Error", e);
                        document.getElementById('status-label').innerText = "READY";
                    }
                } else {
                    document.getElementById('status-label').innerText = "READY";
                }

            } catch (e) {
                console.error(e);
                document.getElementById('status-label').innerText = "ERROR - TRY AGAIN";
                document.getElementById('stage').classList.remove('listening');
                // Auto reset after 3s
                setTimeout(() => {
                    if (document.getElementById('status-label').innerText.includes("ERROR")) {
                        document.getElementById('status-label').innerText = "READY";
                    }
                }, 3000);
            }
        }

        // --- GLOBAL SAFETY WATCHDOG ---
        setInterval(() => {
            const status = document.getElementById('status-label').innerText;
            const stage = document.getElementById('stage');

            // Limit "PROCESSING" time
            if (status.includes("PROCESSING")) {
                const elapsed = Date.now() - (window.lastActionTime || Date.now());
                if (elapsed > 15000) { // 15s Limit
                    console.warn("Watchdog: Hard Reset (Processing Stuck)");
                    document.getElementById('status-label').innerText = "READY";
                    stage.classList.remove('listening');
                }
            }

            // Limit "SPEAKING" time (in case audio callback fails)
            if (status.includes("SPEAKING")) {
                // We don't track time for speaking easily, but we can ensure it doesn't stay forever.
                // Let's rely on a rough counter or just re-check if audio is actually playing?
                // Simpler: Just force clear after 60s max for any speech.
                if (!window.speechStartTime) window.speechStartTime = Date.now();
                if (Date.now() - window.speechStartTime > 60000) {
                    console.warn("Watchdog: Hard Reset (Speaking Stuck)");
                    document.getElementById('status-label').innerText = "READY";
                    window.speechStartTime = null;
                }
            } else {
                window.speechStartTime = null;
            }

            // Track Action Time
            if (status.includes("LISTENING") || status.includes("PROCESSING")) {
                if (!window.lastActionTime) window.lastActionTime = Date.now();
            } else {
                window.lastActionTime = null;
            }

        }, 1000);

        // Initialize
        createStars();

        function createStars() {
            const container = document.getElementById('starfield');
            const starCount = 150;

            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';

                // Random Size
                const size = Math.random() * 2 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';

                // Random Position
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';

                // Random Delay
                star.style.animationDelay = (Math.random() * -100) + 's';

                // Layers for Parallax
                if (size < 1.5) star.classList.add('star-layer3');
                else if (size < 2) star.classList.add('star-layer2');

                container.appendChild(star);
            }
        }
    </script>
</body>

</html>
```